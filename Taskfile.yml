---
version: "3"
tasks:
  default:
    aliases:
      - list
      - l
    desc: List all tasks if none is specified
    cmd: task --list-all
  switch:
    desc: Runs the appropriate switch command for the platform
    aliases:
      - s
    cmds:
      - cmd: task switch:osx
        platforms: [darwin]
      - cmd: task switch:nixos
        platforms: [linux]
  switch:osx:
    desc: Perform osx build and switch
    platforms: [darwin]
    cmd: |
      HOSTNAME=$(hostname -s)
      PASSWORD_PATH="op://Private/${HOSTNAME} Sudo Password/password"
      op run \
        --env-file=<(echo "SUDO_PASSWORD=$(op read "$PASSWORD_PATH")") \
        -- bash -c 'echo "$SUDO_PASSWORD" | sudo -S darwin-rebuild switch --flake ./'
  switch:nixos:
    desc: Perform linux based build
    aliases:
      - linux
    platforms: [linux]
    cmd: sudo nixos-rebuild switch --flake ./
  test:
    desc: Run flake check (now defaults to quick)
    aliases:
      - t
    cmds:
      - task test:quick
  test:quick:
    desc: "Quick syntax and validation checks (30s) - Reports all failures"
    aliases:
      - tq
    cmds:
      - cmd: |
          echo "Running quick validation checks..."
          failed_checks=""

          # Test basic flake validation
          echo "üîç Checking flake structure and dependencies..."
          if ! nix flake check --no-build >/dev/null 2>&1; then
            echo "‚ùå Flake check failed"
            echo "üêõ Running flake check with verbose output for debugging:"
            nix flake check --no-build --show-trace
            failed_checks="$failed_checks flake-check"
          else
            echo "‚úÖ Flake check passed"
          fi

          # Test Linux configurations
          for config in drlight zero; do
            echo "üêß Validating NixOS $config configuration..."
            if nix eval .#nixosConfigurations.$config.config.system.build.toplevel \
              --json >/dev/null 2>&1; then
              echo "‚úÖ NixOS $config configuration valid"
            else
              echo "‚ùå NixOS $config configuration invalid"
              echo "üêõ Running evaluation with verbose output for debugging:"
              nix eval .#nixosConfigurations.$config.config.system.build.toplevel \
                --json --show-trace
              failed_checks="$failed_checks NixOS:$config"
            fi
          done

          # Test macOS configurations
          for config in wweaver MegamanX; do
            echo "üçé Validating Darwin $config configuration..."
            if nix eval .#darwinConfigurations.$config.system \
              --json >/dev/null 2>&1; then
              echo "‚úÖ Darwin $config configuration valid"
            else
              echo "‚ùå Darwin $config configuration invalid"
              echo "üêõ Running evaluation with verbose output for debugging:"
              nix eval .#darwinConfigurations.$config.system \
                --json --show-trace
              failed_checks="$failed_checks Darwin:$config"
            fi
          done

          # Report all failures
          if [ -n "$failed_checks" ]; then
            echo ""
            echo "üíÄ QUICK VALIDATION FAILED"
            echo "Failed checks:$failed_checks"
            echo ""
            echo "üîß To debug individual issues:"
            for check in $failed_checks; do
              case $check in
                "flake-check")
                  echo "  - Run: nix flake check --no-build --show-trace"
                  ;;
                "NixOS:"*)
                  config=${check#NixOS:}
                  echo "  - Run: nix eval \\"
                  echo "             .#nixosConfigurations.$config.config.system.build.toplevel \\"
                  echo "             --json --show-trace"
                  ;;
                "Darwin:"*)
                  config=${check#Darwin:}
                  echo "  - Run: nix eval \\"
                  echo "             .#darwinConfigurations.$config.system \\"
                  echo "             --json --show-trace"
                  ;;
              esac
            done
            exit 1
          else
            echo "‚úÖ All quick validation checks passed"
          fi
  test:full:
    desc: "Full cross-platform verification (5-10min) - Fail fast"
    aliases:
      - tf
    cmds:
      - echo "Universal Cross-Platform Testing Suite"
      - echo "Validating configuration definitions..."
      - cmd: |
          echo "üêß Validating NixOS drlight configuration..."
          if nix eval .#nixosConfigurations.drlight.config.system.build.toplevel \
            --json >/dev/null 2>&1; then
            echo "‚úÖ NixOS drlight configuration valid"
          else
            echo "‚ùå NixOS drlight configuration invalid"
            echo "üêõ Running with verbose output for debugging:"
            nix eval .#nixosConfigurations.drlight.config.system.build.toplevel \
              --json --show-trace
            exit 1
          fi
      - cmd: |
          echo "üêß Validating NixOS zero configuration..."
          if nix eval .#nixosConfigurations.zero.config.system.build.toplevel \
            --json >/dev/null 2>&1; then
            echo "‚úÖ NixOS zero configuration valid"
          else
            echo "‚ùå NixOS zero configuration invalid"
            echo "üêõ Running with verbose output for debugging:"
            nix eval .#nixosConfigurations.zero.config.system.build.toplevel \
              --json --show-trace
            exit 1
          fi
      - cmd: |
          echo "üçé Validating Darwin wweaver configuration..."
          if nix eval .#darwinConfigurations.wweaver.system \
            --json >/dev/null 2>&1; then
            echo "‚úÖ Darwin wweaver configuration valid"
          else
            echo "‚ùå Darwin wweaver configuration invalid"
            echo "üêõ Running with verbose output for debugging:"
            nix eval .#darwinConfigurations.wweaver.system \
              --json --show-trace
            exit 1
          fi
      - cmd: |
          echo "üçé Validating Darwin MegamanX configuration..."
          if nix eval .#darwinConfigurations.MegamanX.system \
            --json >/dev/null 2>&1; then
            echo "‚úÖ Darwin MegamanX configuration valid"
          else
            echo "‚ùå Darwin MegamanX configuration invalid"
            echo "üêõ Running with verbose output for debugging:"
            nix eval .#darwinConfigurations.MegamanX.system \
              --json --show-trace
            exit 1
          fi
      - echo "Testing Linux build plans..."
      - cmd: |
          echo "üîç Testing drlight build plan..."
          if nix build .#nixosConfigurations.drlight.config.system.build.toplevel \
            --dry-run --quiet >/dev/null 2>&1; then
            echo "‚úÖ drlight build plan validated"
          else
            echo "‚ùå drlight build plan failed"
            echo "üêõ Running build plan with verbose output for debugging:"
            nix build .#nixosConfigurations.drlight.config.system.build.toplevel \
              --dry-run --show-trace
            exit 1
          fi
      - cmd: |
          echo "üîç Testing zero build plan..."
          if nix build .#nixosConfigurations.zero.config.system.build.toplevel \
            --dry-run --quiet >/dev/null 2>&1; then
            echo "‚úÖ zero build plan validated"
          else
            echo "‚ùå zero build plan failed"
            echo "üêõ Running build plan with verbose output for debugging:"
            nix build .#nixosConfigurations.zero.config.system.build.toplevel \
              --dry-run --show-trace
            exit 1
          fi
      - echo "Testing Darwin evaluations..."
      - cmd: |
          echo "üîç Testing wweaver evaluation..."
          if nix eval .#darwinConfigurations.wweaver.system \
            --quiet >/dev/null 2>&1; then
            echo "‚úÖ wweaver evaluation validated"
          else
            echo "‚ùå wweaver evaluation failed"
            echo "üêõ Running evaluation with verbose output for debugging:"
            nix eval .#darwinConfigurations.wweaver.system \
              --show-trace
            exit 1
          fi
      - cmd: |
          echo "üîç Testing MegamanX evaluation..."
          if nix eval .#darwinConfigurations.MegamanX.system \
            --quiet >/dev/null 2>&1; then
            echo "‚úÖ MegamanX evaluation validated"
          else
            echo "‚ùå MegamanX evaluation failed"
            echo "üêõ Running evaluation with verbose output for debugging:"
            nix eval .#darwinConfigurations.MegamanX.system \
              --show-trace
            exit 1
          fi
      - echo "Universal cross-platform testing completed!"
      - echo "Results Summary"
      - echo "   Configuration validation = SUCCESS"
      - echo "   Linux build planning = SUCCESS"
      - echo "   Darwin evaluation = SUCCESS"
      - echo "   Host-agnostic execution = SUCCESS"
  test:darwin-only:
    desc: "Test only Darwin configurations (for Darwin runners)"
    cmds:
      - echo "Testing Darwin configurations"
      - echo "=================================="
      - echo "Testing wweaver build plan"
      - cmd: |
          echo "üîç Testing wweaver build plan..."
          if nix build .#darwinConfigurations.wweaver.system --dry-run >/dev/null 2>&1; then
            echo "‚úÖ wweaver build plan validated"
          else
            echo "‚ùå wweaver build plan failed"
            echo ""
            echo "üêõ Running build plan with verbose output for debugging:"
            nix build .#darwinConfigurations.wweaver.system --dry-run --show-trace
            echo ""
            echo "üí° Common issues to check:"
            echo "  - Missing or incompatible packages in bundles"
            echo "  - Incorrect paths in configurations"
            echo "  - Platform-specific incompatibilities"
            exit 1
          fi
      - echo "Testing MegamanX build plan"
      - cmd: |
          echo "üîç Testing MegamanX build plan..."
          if nix build .#darwinConfigurations.MegamanX.system --dry-run >/dev/null 2>&1; then
            echo "‚úÖ MegamanX build plan validated"
          else
            echo "‚ùå MegamanX build plan failed"
            echo ""
            echo "üêõ Running build plan with verbose output for debugging:"
            nix build .#darwinConfigurations.MegamanX.system --dry-run --show-trace
            echo ""
            echo "üí° Common issues to check:"
            echo "  - Missing or incompatible packages in bundles"
            echo "  - Incorrect paths in configurations"
            echo "  - Platform-specific incompatibilities"
            exit 1
          fi
      - echo "All Darwin tests completed"
  test:nixos-only:
    desc: "Test only NixOS configurations (for Linux runners)"
    cmds:
      - echo "Testing NixOS configurations"
      - echo "================================="
      - echo "Testing drlight build plan"
      - cmd: |
          echo "üîç Testing drlight build plan..."
          if nix build .#nixosConfigurations.drlight.config.system.build.toplevel \
              --dry-run --quiet >/dev/null 2>&1; then
            echo "‚úÖ drlight build plan validated"
          else
            echo "‚ùå drlight build plan failed"
            echo ""
            echo "üêõ Running build plan with verbose output for debugging:"
            nix build .#nixosConfigurations.drlight.config.system.build.toplevel \
              --dry-run --show-trace
            echo ""
            echo "üí° Common issues to check:"
            echo "  - Missing or incompatible packages in bundles"
            echo "  - Incorrect hardware configuration paths"
            echo "  - Platform-specific module incompatibilities"
            exit 1
          fi
      - echo "Testing zero build plan"
      - cmd: |
          echo "üîç Testing zero build plan..."
          if nix build .#nixosConfigurations.zero.config.system.build.toplevel \
              --dry-run --quiet >/dev/null 2>&1; then
            echo "‚úÖ zero build plan validated"
          else
            echo "‚ùå zero build plan failed"
            echo ""
            echo "üêõ Running build plan with verbose output for debugging:"
            nix build .#nixosConfigurations.zero.config.system.build.toplevel \
              --dry-run --show-trace
            echo ""
            echo "üí° Common issues to check:"
            echo "  - Missing or incompatible packages in bundles"
            echo "  - Incorrect hardware configuration paths"
            echo "  - Platform-specific module incompatibilities"
            exit 1
          fi
      - echo "All NixOS tests completed"
  build:
    desc: build all configurations
    aliases:
      - b
    cmds:
      - echo "üîç building flake configurations..."
      - task: build:darwin
      - task: build:nixos
      - echo "‚úÖ All configurations (NixOS and Darwin) validated successfully"
  build:darwin:
    desc: build all Darwin (macOS) configurations
    cmds:
      - echo "üçé building Darwin configurations..."
      # - task: build:darwin:will-stride-mbp
      - task: build:darwin:megamanx
      - echo "‚úÖ All Darwin configurations validated successfully"
  build:nixos:
    desc: build all NixOS configurations
    cmds:
      - echo "üêß building NixOS configurations..."
      - task: build:nixos:drlight
      # - task: build:nixos:zero
      - echo "‚úÖ All NixOS configurations validated successfully"
  quality:
    desc: Run all code quality checks.
    aliases:
      - q
    cmds:
      - devenv test
  dev:
    desc: Enter development shell with all tools available.
    aliases:
      - d
    cmd: devenv shell
  devenv:update:
    desc: Update devenv lock file.
    cmd: devenv update
  init:
    desc: Initial setup commands
    cmds:
      - sudo nix run nix-darwin/master#darwin-rebuild -- switch --flake ./
  git:set-remote-ssh:
    desc: Switch
    cmds:
      - git remote -v
      - git remote set-url origin git@github.com:funkymonkeymonk/nix.git
      - git remote -v
  git:set-remote-https:
    desc: Switch
    cmds:
      - git remote -v
      - git remote set-url origin https://github.com/funkymonkeymonk/nix.git
      - git remote -v
  flake:update:
    desc: Update the nix flake to latest versions
    cmd: nix flake update
