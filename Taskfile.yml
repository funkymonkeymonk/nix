---
version: "3"
tasks:
  default:
    aliases:
      - list
      - l
    desc: List all tasks if none is specified
    cmd: task --list-all
  switch:
    desc: Runs the appropriate switch command for the platform
    aliases:
      - s
    cmds:
      - cmd: task switch:osx
        platforms: [darwin]
      - cmd: task switch:nixos
        platforms: [linux]
  switch:osx:
    desc: Perform osx build and switch
    platforms: [darwin]
    cmd: |
      HOSTNAME=$(hostname -s)
      PASSWORD_PATH="op://Private/${HOSTNAME} Sudo Password/password"
      op run \
        --env-file=<(echo "SUDO_PASSWORD=$(op read "$PASSWORD_PATH")") \
        -- bash -c 'echo "$SUDO_PASSWORD" | sudo -S darwin-rebuild switch --flake ./'
  switch:nixos:
    desc: Perform linux based build
    aliases:
      - linux
    platforms: [linux]
    cmd: sudo nixos-rebuild switch --flake ./
  test:
    desc: Run flake check (now defaults to quick)
    aliases:
      - t
    cmds:
      - task test:quick
  test:quick:
    desc: "Quick syntax and validation checks (30s) - Reports all failures"
    aliases:
      - tq
    cmds:
      - cmd: |
          echo "Running quick validation checks..."
          failed_checks=""

          # Test basic flake validation
          echo "üîç Checking flake structure and dependencies..."
          if ! nix flake check --no-build >/dev/null 2>&1; then
            echo "‚ùå Flake check failed"
            echo "üêõ Running flake check with verbose output for debugging:"
            nix flake check --no-build --show-trace
            failed_checks="$failed_checks flake-check"
          else
            echo "‚úÖ Flake check passed"
          fi

          # Test Linux configurations
          for config in drlight zero; do
            echo "üêß Validating NixOS $config configuration..."
            if nix eval .#nixosConfigurations.$config.config.system.build.toplevel \
              --json >/dev/null 2>&1; then
              echo "‚úÖ NixOS $config configuration valid"
            else
              echo "‚ùå NixOS $config configuration invalid"
              echo "üêõ Running evaluation with verbose output for debugging:"
              nix eval .#nixosConfigurations.$config.config.system.build.toplevel \
                --json --show-trace
              failed_checks="$failed_checks NixOS:$config"
            fi
          done

          # Test macOS configurations
          for config in wweaver MegamanX; do
            echo "üçé Validating Darwin $config configuration..."
            if nix eval .#darwinConfigurations.$config.system \
              --json >/dev/null 2>&1; then
              echo "‚úÖ Darwin $config configuration valid"
            else
              echo "‚ùå Darwin $config configuration invalid"
              echo "üêõ Running evaluation with verbose output for debugging:"
              nix eval .#darwinConfigurations.$config.system \
                --json --show-trace
              failed_checks="$failed_checks Darwin:$config"
            fi
          done

          # Report all failures
          if [ -n "$failed_checks" ]; then
            echo ""
            echo "üíÄ QUICK VALIDATION FAILED"
            echo "Failed checks:$failed_checks"
            echo ""
            echo "üîß To debug individual issues:"
            for check in $failed_checks; do
              case $check in
                "flake-check")
                  echo "  - Run: nix flake check --no-build --show-trace"
                  ;;
                "NixOS:"*)
                  config=${check#NixOS:}
                  echo "  - Run: nix eval \\"
                  echo "             .#nixosConfigurations.$config.config.system.build.toplevel \\"
                  echo "             --json --show-trace"
                  ;;
                "Darwin:"*)
                  config=${check#Darwin:}
                  echo "  - Run: nix eval \\"
                  echo "             .#darwinConfigurations.$config.system \\"
                  echo "             --json --show-trace"
                  ;;
              esac
            done
            exit 1
          else
            echo "‚úÖ All quick validation checks passed"
          fi
  test:full:
    desc: "Full cross-platform verification (5-10min) - Fail fast"
    aliases:
      - tf
    cmds:
      - echo "Universal Cross-Platform Testing Suite"
      - echo "Validating configuration definitions..."
      - cmd: |
          echo "üêß Validating NixOS drlight configuration..."
          if nix eval .#nixosConfigurations.drlight.config.system.build.toplevel \
            --json >/dev/null 2>&1; then
            echo "‚úÖ NixOS drlight configuration valid"
          else
            echo "‚ùå NixOS drlight configuration invalid"
            echo "üêõ Running with verbose output for debugging:"
            nix eval .#nixosConfigurations.drlight.config.system.build.toplevel \
              --json --show-trace
            exit 1
          fi
      - cmd: |
          echo "üêß Validating NixOS zero configuration..."
          if nix eval .#nixosConfigurations.zero.config.system.build.toplevel \
            --json >/dev/null 2>&1; then
            echo "‚úÖ NixOS zero configuration valid"
          else
            echo "‚ùå NixOS zero configuration invalid"
            echo "üêõ Running with verbose output for debugging:"
            nix eval .#nixosConfigurations.zero.config.system.build.toplevel \
              --json --show-trace
            exit 1
          fi
      - cmd: |
          echo "üçé Validating Darwin wweaver configuration..."
          if nix eval .#darwinConfigurations.wweaver.system \
            --json >/dev/null 2>&1; then
            echo "‚úÖ Darwin wweaver configuration valid"
          else
            echo "‚ùå Darwin wweaver configuration invalid"
            echo "üêõ Running with verbose output for debugging:"
            nix eval .#darwinConfigurations.wweaver.system \
              --json --show-trace
            exit 1
          fi
      - cmd: |
          echo "üçé Validating Darwin MegamanX configuration..."
          if nix eval .#darwinConfigurations.MegamanX.system \
            --json >/dev/null 2>&1; then
            echo "‚úÖ Darwin MegamanX configuration valid"
          else
            echo "‚ùå Darwin MegamanX configuration invalid"
            echo "üêõ Running with verbose output for debugging:"
            nix eval .#darwinConfigurations.MegamanX.system \
              --json --show-trace
            exit 1
          fi
      - echo "Testing Linux build plans..."
      - cmd: |
          echo "üîç Testing drlight build plan..."
          if nix build .#nixosConfigurations.drlight.config.system.build.toplevel \
            --dry-run --quiet >/dev/null 2>&1; then
            echo "‚úÖ drlight build plan validated"
          else
            echo "‚ùå drlight build plan failed"
            echo "üêõ Running build plan with verbose output for debugging:"
            nix build .#nixosConfigurations.drlight.config.system.build.toplevel \
              --dry-run --show-trace
            exit 1
          fi
      - cmd: |
          echo "üîç Testing zero build plan..."
          if nix build .#nixosConfigurations.zero.config.system.build.toplevel \
            --dry-run --quiet >/dev/null 2>&1; then
            echo "‚úÖ zero build plan validated"
          else
            echo "‚ùå zero build plan failed"
            echo "üêõ Running build plan with verbose output for debugging:"
            nix build .#nixosConfigurations.zero.config.system.build.toplevel \
              --dry-run --show-trace
            exit 1
          fi
      - echo "Testing Darwin evaluations..."
      - cmd: |
          echo "üîç Testing wweaver evaluation..."
          if nix eval .#darwinConfigurations.wweaver.system \
            --quiet >/dev/null 2>&1; then
            echo "‚úÖ wweaver evaluation validated"
          else
            echo "‚ùå wweaver evaluation failed"
            echo "üêõ Running evaluation with verbose output for debugging:"
            nix eval .#darwinConfigurations.wweaver.system \
              --show-trace
            exit 1
          fi
      - cmd: |
          echo "üîç Testing MegamanX evaluation..."
          if nix eval .#darwinConfigurations.MegamanX.system \
            --quiet >/dev/null 2>&1; then
            echo "‚úÖ MegamanX evaluation validated"
          else
            echo "‚ùå MegamanX evaluation failed"
            echo "üêõ Running evaluation with verbose output for debugging:"
            nix eval .#darwinConfigurations.MegamanX.system \
              --show-trace
            exit 1
          fi
      - echo "Universal cross-platform testing completed!"
      - echo "Results Summary"
      - echo "   Configuration validation = SUCCESS"
      - echo "   Linux build planning = SUCCESS"
      - echo "   Darwin evaluation = SUCCESS"
      - echo "   Host-agnostic execution = SUCCESS"
  test:darwin-only:
    desc: "Test only Darwin configurations (for Darwin runners)"
    cmds:
      - echo "Testing Darwin configurations"
      - echo "=================================="
      - echo "Testing wweaver build plan"
      - cmd: |
          echo "üîç Testing wweaver build plan..."
          if nix build .#darwinConfigurations.wweaver.system --dry-run >/dev/null 2>&1; then
            echo "‚úÖ wweaver build plan validated"
          else
            echo "‚ùå wweaver build plan failed"
            echo ""
            echo "üêõ Running build plan with verbose output for debugging:"
            nix build .#darwinConfigurations.wweaver.system --dry-run --show-trace
            echo ""
            echo "üí° Common issues to check:"
            echo "  - Missing or incompatible packages in bundles"
            echo "  - Incorrect paths in configurations"
            echo "  - Platform-specific incompatibilities"
            exit 1
          fi
      - echo "Testing MegamanX build plan"
      - cmd: |
          echo "üîç Testing MegamanX build plan..."
          if nix build .#darwinConfigurations.MegamanX.system --dry-run >/dev/null 2>&1; then
            echo "‚úÖ MegamanX build plan validated"
          else
            echo "‚ùå MegamanX build plan failed"
            echo ""
            echo "üêõ Running build plan with verbose output for debugging:"
            nix build .#darwinConfigurations.MegamanX.system --dry-run --show-trace
            echo ""
            echo "üí° Common issues to check:"
            echo "  - Missing or incompatible packages in bundles"
            echo "  - Incorrect paths in configurations"
            echo "  - Platform-specific incompatibilities"
            exit 1
          fi
      - echo "All Darwin tests completed"
  test:nixos-only:
    desc: "Test only NixOS configurations (for Linux runners)"
    cmds:
      - echo "Testing NixOS configurations"
      - echo "================================="
      - echo "Testing drlight build plan"
      - cmd: |
          echo "üîç Testing drlight build plan..."
          if nix build .#nixosConfigurations.drlight.config.system.build.toplevel \
              --dry-run --quiet >/dev/null 2>&1; then
            echo "‚úÖ drlight build plan validated"
          else
            echo "‚ùå drlight build plan failed"
            echo ""
            echo "üêõ Running build plan with verbose output for debugging:"
            nix build .#nixosConfigurations.drlight.config.system.build.toplevel \
              --dry-run --show-trace
            echo ""
            echo "üí° Common issues to check:"
            echo "  - Missing or incompatible packages in bundles"
            echo "  - Incorrect hardware configuration paths"
            echo "  - Platform-specific module incompatibilities"
            exit 1
          fi
      - echo "Testing zero build plan"
      - cmd: |
          echo "üîç Testing zero build plan..."
          if nix build .#nixosConfigurations.zero.config.system.build.toplevel \
              --dry-run --quiet >/dev/null 2>&1; then
            echo "‚úÖ zero build plan validated"
          else
            echo "‚ùå zero build plan failed"
            echo ""
            echo "üêõ Running build plan with verbose output for debugging:"
            nix build .#nixosConfigurations.zero.config.system.build.toplevel \
              --dry-run --show-trace
            echo ""
            echo "üí° Common issues to check:"
            echo "  - Missing or incompatible packages in bundles"
            echo "  - Incorrect hardware configuration paths"
            echo "  - Platform-specific module incompatibilities"
            exit 1
          fi
      - echo "All NixOS tests completed"
  build:
    desc: build all configurations
    aliases:
      - b
    cmds:
      - echo "üîç building flake configurations..."
      - task: build:darwin
      - task: build:nixos
      - echo "‚úÖ All configurations (NixOS and Darwin) validated successfully"
  build:darwin:
    desc: build all Darwin (macOS) configurations
    cmds:
      - echo "üçé building Darwin configurations..."
      # - task: build:darwin:will-stride-mbp
      - task: build:darwin:megamanx
      - echo "‚úÖ All Darwin configurations validated successfully"
  build:nixos:
    desc: build all NixOS configurations
    cmds:
      - echo "üêß building NixOS configurations..."
      - task: build:nixos:drlight
      # - task: build:nixos:zero
      - echo "‚úÖ All NixOS configurations validated successfully"
  quality:
    desc: Run all code quality checks.
    aliases:
      - q
    cmds:
      - devenv test
  dev:
    desc: Enter development shell with all tools available.
    aliases:
      - d
    cmd: devenv shell
  devenv:update:
    desc: Update devenv lock file.
    cmd: devenv update
  init:
    desc: Initial setup commands
    cmds:
      - sudo nix run nix-darwin/master#darwin-rebuild -- switch --flake ./
  git:set-remote-ssh:
    desc: Switch
    cmds:
      - git remote -v
      - git remote set-url origin git@github.com:funkymonkeymonk/nix.git
      - git remote -v
  git:set-remote-https:
    desc: Switch
    cmds:
      - git remote -v
      - git remote set-url origin https://github.com/funkymonkeymonk/nix.git
      - git remote -v
  flake:update:
    desc: Update the nix flake to latest versions
    cmd: nix flake update
  1password:service:setup:
    desc: "Set up 1Password service account for this machine (first time)"
    deps: [1password:setup]
    cmds:
      - cmd: |
          echo "üîß Setting up 1Password service account"
          echo "==================================="
          
          # Verify user is authenticated
          if ! op user get >/dev/null 2>&1; then
            echo "‚ùå No 1Password account found"
            echo ""
            echo "üîê Please add your 1Password account first:"
            echo "   task 1password:account:add"
            echo ""
            echo "This will guide you through account setup and authentication."
            exit 1
          fi
          
          ACCOUNT_EMAIL=$(op user get --format json | jq -r '.email // "unknown"')
          echo "üì± Using 1Password account: $ACCOUNT_EMAIL"
          echo ""
          
          # Verify access to Homelab vault
          echo "üîé Checking access to Homelab vault..."
          if ! op vault list --format json | jq -r '.[] | select(.name=="Homelab") | .name' | grep -q "Homelab"; then
            echo "‚ùå No access to Homelab vault found"
            echo ""
            echo "üîê Please ensure:"
            echo "   1. You have been invited to the Homelab vault"
            echo "   2. You have accepted the vault invitation"
            echo "   3. The vault is synced in your 1Password client"
            echo ""
            echo "Contact your 1Password administrator if you need access."
            exit 1
          fi
          
          echo "‚úÖ Access to Homelab vault confirmed"
      - task: 1password:service:generate-token
      - task: 1password:service:validate
  1password:service:generate-token:
    desc: "Generate new 1Password service account token"
    platforms: [linux]
    cmd: |
      echo "üîß Setting up 1Password service account token"
      echo "=========================================="

      # Check if 1Password CLI is available
      if ! command -v op >/dev/null 2>&1; then
        echo "‚ùå 1Password CLI not found. Please install it first:"
        echo "   nix shell nixpkgs#_1password-cli"
        exit 1
      fi

      # Check if user is authenticated with 1Password
      if ! op user get >/dev/null 2>&1; then
        echo "‚ùå Not authenticated with 1Password. Please run:"
        echo "   op account add"
        exit 1
      fi

      # Get machine name for service account identification
      MACHINE_NAME=$(hostname)
      SERVICE_ACCOUNT_NAME="nixos-${MACHINE_NAME}"

      echo "üìù Creating service account: ${SERVICE_ACCOUNT_NAME}"
      echo "üîê This service account will have read access to Homelab vault secrets"

      # Generate service account (this will require 1Password CLI with appropriate perms)
      # Note: This assumes the user has the ability to create service accounts
      if op service-account create --name "${SERVICE_ACCOUNT_NAME}"
         --vaults Homelab >/dev/null 2>&1; then
        echo "‚úÖ Service account created successfully"
      else
        echo "‚ö†Ô∏è  Service account may already exist or needs manual creation"
        echo "   Please ensure '${SERVICE_ACCOUNT_NAME}' has read access to Homelab vault"
      fi

      # Get service account token
      echo "üé´ Generating service account token..."
      SERVICE_TOKEN=$(op service-account get "${SERVICE_ACCOUNT_NAME}" \
        --format json 2>/dev/null | jq -r '.token // empty')

      if [ -z "$SERVICE_TOKEN" ]; then
        echo "‚ùå Failed to get service account token"
        echo "   Please ensure the service account exists and you have permission to access it"
        exit 1
      fi

      # Store token with proper permissions
      echo "üìÅ Storing token to /etc/opnix-token..."
      echo "$SERVICE_TOKEN" | sudo tee /etc/opnix-token >/dev/null
      sudo chmod 600 /etc/opnix-token
      sudo chown root:root /etc/opnix-token

      echo "‚úÖ Service account token stored successfully"
      echo "üìç Location: /etc/opnix-token (root:root 0600)"
      echo "üîÑ Run 'task 1password:service:validate' to verify access"
  1password:service:validate:
    desc: "Validate 1Password service account token and secret access"
    platforms: [linux]
    cmd: |
      echo "üîç Validating 1Password service account configuration"
      echo "==============================================="

      # Check if token file exists
      if [[ ! -f /etc/opnix-token ]]; then
        echo "‚ùå Service token file not found at /etc/opnix-token"
        echo "   Run 'task 1password:service:setup' to create it"
        exit 1
      fi

      # Check permissions
      TOKEN_PERM=$(stat -c "%a" /etc/opnix-token)
      TOKEN_OWNER=$(stat -c "%U:%G" /etc/opnix-token)

      if [[ "$TOKEN_PERM" != "600" ]]; then
        echo "‚ö†Ô∏è  Token file has incorrect permissions: $TOKEN_PERM (should be 600)"
        sudo chmod 600 /etc/opnix-token
      fi

      if [[ "$TOKEN_OWNER" != "root:root" ]]; then
        echo "‚ö†Ô∏è  Token file has incorrect ownership: $TOKEN_OWNER (should be root:root)"
        sudo chown root:root /etc/opnix-token
      fi

      # Test token authentication
      echo "üîê Testing service account authentication..."
      export OP_SERVICE_ACCOUNT_TOKEN=$(cat /etc/opnix-token)

      if ! op account get >/dev/null 2>&1; then
        echo "‚ùå Service account authentication failed"
        echo "   Token may be expired or invalid"
        echo "   Run 'task 1password:service:rotate' to generate a new token"
        exit 1
      fi

      echo "‚úÖ Service account authentication successful"

      # Test access to required secrets
      echo "üîé Testing access to required secrets..."
      SECRETS_TO_TEST=(
        "op://Homelab/Linkwarden Database Password/password"
        "op://Homelab/Linkwarden NextAuth Secret/password"
        "op://Homelab/Meilisearch Key/password"
      )

      FAILED_SECRETS=()
      for secret_ref in "${SECRETS_TO_TEST[@]}"; do
        secret_name=$(basename "$(dirname "$secret_ref") | sed 's/ /_/g' | tr '[:upper:]' '[:lower:]'")
        echo "   Testing $secret_name..."
        if op read "$secret_ref" >/dev/null 2>&1; then
          echo "   ‚úÖ $secret_name accessible"
        else
          echo "   ‚ùå $secret_name not accessible"
          FAILED_SECRETS+=("$secret_name")
        fi
      done

      if [[ ${#FAILED_SECRETS[@]} -gt 0 ]]; then
        echo ""
        echo "‚ùå Some secrets are not accessible:"
        for secret in "${FAILED_SECRETS[@]}"; do
          echo "   - $secret"
        done
        echo ""
        echo "üîß Please ensure the service account has read access to these items in 1Password"
        exit 1
      fi

      echo ""
      echo "‚úÖ All validations passed!"
      echo "üöÄ Service account is ready for use with OpNix"
  1password:service:rotate:
    desc: "Rotate existing 1Password service account token"
    platforms: [linux]
    cmds:
      - task: 1password:service:generate-token
      - cmd: |
          echo "üîÑ Restarting onepassword-secrets service..."
          sudo systemctl restart onepassword-secrets.service || echo "‚ö†Ô∏è  Service not yet enabled (expected before first switch)"
  1password:account:add:
    desc: "Add and authenticate 1Password account"
    platforms: [linux]
    cmd: |
      echo "üîê Adding 1Password account"
      echo "============================"
      
      # Check if 1Password CLI is available
      if ! command -v op >/dev/null 2>&1; then
        echo "‚ùå 1Password CLI not found. Installing..."
        sudo nix profile install nixpkgs#_1password-cli
      fi
      
      # Check if already authenticated
      if op user get >/dev/null 2>&1; then
        echo "‚úÖ 1Password CLI is already authenticated"
        echo "üì± Current account: $(op user get --format json | jq -r '.email // "unknown"')"
        echo ""
        echo "If you want to use a different account:"
        echo "   1. Sign out: op signout"
        echo "   2. Run this task again"
        exit 0
      fi
      
      echo "üöÄ Starting 1Password account setup..."
      echo ""
      echo "This will guide you through adding your 1Password account to this machine."
      echo "You'll need:"
      echo "  - Your 1Password account email"
      echo "  - Your 1Password account password"
      echo "  - Access to your email for verification"
      echo ""
      read -p "Press Enter to continue..."
      
      # Add the account
      op account add
      
      if op user get >/dev/null 2>&1; then
        ACCOUNT_EMAIL=$(op user get --format json | jq -r '.email // "unknown"')
        echo "‚úÖ 1Password account setup successful!"
        echo "üì± Account: $ACCOUNT_EMAIL"
        echo ""
        echo "üéØ Next steps:"
        echo "   1. Ensure you have access to Homelab vault"
        echo "   2. Run: task 1password:service:setup"
        echo "   3. Run: task switch:nixos"
      else
        echo "‚ùå 1Password account setup failed"
        echo "   Please check your credentials and try again"
        echo "   Run: task 1password:account:add"
        exit 1
      fi
  1password:setup:
    desc: "Set up 1Password CLI authentication"
    platforms: [linux]
    cmd: |
      echo "üîß Setting up 1Password CLI authentication"
      echo "======================================="
      
      # Check if 1Password CLI is available
      if ! command -v op >/dev/null 2>&1; then
        echo "‚ùå 1Password CLI not found. Installing..."
        sudo nix profile install nixpkgs#_1password-cli
      fi
      
      # Check if user is already authenticated
      if ! op user get >/dev/null 2>&1; then
        echo "‚ùå No 1Password account found on this system"
        echo ""
        echo "üîê Please add your 1Password account first:"
        echo "   task 1password:account:add"
        echo ""
        echo "This will guide you through account setup and authentication."
        exit 1
      fi
      
      ACCOUNT_EMAIL=$(op user get --format json | jq -r '.email // "unknown"')
      echo "‚úÖ 1Password CLI is authenticated and ready"
      echo "üì± Current account: $ACCOUNT_EMAIL"
