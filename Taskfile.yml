---
version: "3"
tasks:
  default:
    aliases:
      - list
      - l
    desc: List all tasks if none is specified
    cmd: task --list-all
  switch:
    desc: Runs the appropriate switch command for the platform
    aliases:
      - s
    cmds:
      - cmd: task switch:osx
        platforms: [darwin]
      - cmd: task switch:nixos
        platforms: [linux]
  switch:osx:
    desc: Perform osx build and switch
    platforms: [darwin]
    cmd: |
      HOSTNAME=$(hostname -s)
      PASSWORD_PATH="op://Private/${HOSTNAME} Sudo Password/password"
      op run \
        --env-file=<(echo "SUDO_PASSWORD=$(op read "$PASSWORD_PATH")") \
        -- bash -c 'echo "$SUDO_PASSWORD" | sudo -S darwin-rebuild switch --flake ./'
  switch:nixos:
    desc: Perform linux based build
    aliases:
      - linux
    platforms: [linux]
    cmd: sudo nixos-rebuild switch --flake ./
  switch:dry-run:osx:
    desc: Perform dry-run switch for darwin platforms
    aliases:
      - dry-run
    platforms: [darwin]
    cmd: |
      HOSTNAME=$(hostname -s)
      PASSWORD_PATH="op://Private/${HOSTNAME} Sudo Password/password"
      op run \
        --env-file=<(echo "SUDO_PASSWORD=$(op read "$PASSWORD_PATH")") \
        -- bash -c 'echo "$SUDO_PASSWORD" | sudo -S darwin-rebuild switch --dry-run --flake ./'
  switch:dry-run:nixos:
    desc: Perform dry-run switch for NixOS platforms
    platforms: [linux]
    cmd: sudo nixos-rebuild dry-activate --flake ./
  test:
    desc: Run flake check
    aliases:
      - t
    cmds:
      - echo "ğŸ” building flake configurations..."
      - nix flake check
      - echo "âœ… All configurations (NixOS and Darwin) validated successfully"
  build:
    desc: build all configurations
    aliases:
      - b
    cmds:
      - echo "ğŸ” building flake configurations..."
      - task: build:darwin
      - task: build:nixos
      - echo "âœ… All configurations (NixOS and Darwin) validated successfully"
  build:darwin:
    desc: build all Darwin (macOS) configurations
    cmds:
      - echo "ğŸ building Darwin configurations..."
      # - task: build:darwin:will-stride-mbp
      - task: build:darwin:megamanx
      - echo "âœ… All Darwin configurations validated successfully"
  build:nixos:
    desc: build all NixOS configurations
    cmds:
      - echo "ğŸ§ building NixOS configurations..."
      - task: build:nixos:drlight
      # - task: build:nixos:zero
      - echo "âœ… All NixOS configurations validated successfully"
  build:darwin:will-stride-mbp:
    desc: Build Will-Stride-MBP Darwin configuration
    cmd: darwin-rebuild build --flake .#Will-Stride-MBP
  build:darwin:megamanx:
    desc: build MegamanX Darwin configuration
    cmd: darwin-rebuild build --flake .#MegamanX
  build:nixos:drlight:
    desc: build drlight NixOS configuration
    cmd: nix build .#nixosConfigurations."drlight".config.system.build.toplevel
  build:nixos:zero:
    desc: build zero NixOS configuration
    cmd: nix build .#nixosConfigurations."zero".config.system.build.toplevel
  fmt:
    desc: Run formatter on all files.
    aliases:
      - f
    cmds:
      - alejandra *.nix
      - yamlfmt .
  lint:
    desc: Run linters on all nix files.
    aliases:
      - l
    cmds:
      - devenv shell -- deadnix --no-underscore .
      - yamllint .
  quality:
    desc: Run all code quality checks (format + lint).
    aliases:
      - q
    cmds:
      - task: fmt
      - task: lint
  dev:
    desc: Enter development shell with all tools available.
    aliases:
      - d
    cmd: devenv shell
  devenv:update:
    desc: Update devenv lock file.
    cmd: devenv update
  secrets-get:
    desc: "Get secrets file using 1Password CLI"
    cmds:
      - echo "ğŸ” Retrieving secrets from 1Password..."
      - op read "op://personal/nix-secrets/secrets.nix" > secrets.nix
      - echo "âœ… Secrets retrieved and saved to secrets.nix"
  secrets-set:
    desc: "Set secrets file using 1Password CLI"
    cmds:
      - echo "ğŸ” Storing secrets to 1Password..."
      - op document create secrets.nix --vault personal --title "Nix Secrets" --tags nix,secrets
      - echo "âœ… Secrets stored in 1Password"
  1password:setup:
    desc: "Set up 1Password CLI authentication"
    cmds:
      - echo "ğŸ” Setting up 1Password CLI..."
      - echo "Please sign in to 1Password CLI:"
      - op signin
      - echo "âœ… 1Password CLI authenticated"
  1password:status:
    desc: "Check 1Password CLI authentication status"
    cmds:
      - echo "ğŸ” Checking 1Password CLI status..."
      - op account list
      - echo "âœ… 1Password CLI is authenticated"
  secrets:init:
    desc: "Initialize secrets management with 1Password"
    cmds:
      - echo "ğŸ” Initializing secrets management..."
      - echo "1. Copy secrets.nix.template to secrets.nix"
      - echo "2. Fill in your secrets in secrets.nix"
      - echo "3. Run 'task secrets-set' to store in 1Password"
      - echo "4. Run 'task secrets-get' to retrieve from 1Password"
      - 'echo "5. Enable secrets in your configuration: myConfig.secrets.enable = true"'
      - cp secrets.nix.template secrets.nix
      - echo "âœ… Template copied to secrets.nix - edit it with your secrets"
  secrets:populate:
    desc: "Automatically populate secrets.nix from 1Password items"
    cmds:
      - echo "ğŸ” Populating secrets from 1Password..."
      - |
        # Read secrets from 1Password with fallbacks
        GIT_USERNAME=$(op read "op://personal/git/username" 2>/dev/null || echo "Your Name")
        GIT_EMAIL=$(op read "op://personal/git/email" 2>/dev/null || echo "your.email@example.com")
        GITHUB_TOKEN=$(op read "op://personal/github/token" 2>/dev/null || echo "")
        OPENAI_KEY=$(op read "op://personal/openai/api-key" 2>/dev/null || echo "")
        ANTHROPIC_KEY=$(op read "op://personal/anthropic/api-key" 2>/dev/null || echo "")
        HUGGINGFACE_TOKEN=$(op read "op://personal/huggingface/token" 2>/dev/null || echo "")
        AWS_ACCESS_KEY=$(op read "op://personal/aws/access-key-id" 2>/dev/null || echo "")
        AWS_SECRET_KEY=$(op read "op://personal/aws/secret-access-key" 2>/dev/null || echo "")
        AWS_REGION=$(op read "op://personal/aws/region" 2>/dev/null || echo "us-east-1")
        DO_TOKEN=$(op read "op://personal/digitalocean/token" 2>/dev/null || echo "")
        HOME_ADDRESS=$(op read "op://personal/address/home" 2>/dev/null || echo "")
        PHONE_PRIMARY=$(op read "op://personal/phone/primary" 2>/dev/null || echo "")
        PHONE_WORK=$(op read "op://personal/phone/work" 2>/dev/null || echo "")
        BIRTHDAY=$(op read "op://personal/birthday" 2>/dev/null || echo "")

        # Generate secrets.nix file
        cat > secrets.nix << EOF
        # Auto-generated secrets from 1Password
        # Generated on $(date)
        {
          # Git configuration
          git = {
            userName = "$GIT_USERNAME";
            userEmail = "$GIT_EMAIL";
            githubToken = "$GITHUB_TOKEN";
          };

          # SSH keys (optional)
          ssh = {
            privateKey = "";
            publicKey = "";
          };

          # API keys and tokens
          apiKeys = {
            openai = "$OPENAI_KEY";
            anthropic = "$ANTHROPIC_KEY";
            huggingface = "$HUGGINGFACE_TOKEN";
          };

          # Database credentials
          databases = {};

          # Cloud service credentials
          cloud = {
            aws = {
              accessKeyId = "$AWS_ACCESS_KEY";
              secretAccessKey = "$AWS_SECRET_KEY";
              region = "$AWS_REGION";
            };
            digitalocean = {
              token = "$DO_TOKEN";
            };
          };

          # Personal/private configuration
          personal = {
            homeAddress = "$HOME_ADDRESS";
            phoneNumbers = {
              primary = "$PHONE_PRIMARY";
              work = "$PHONE_WORK";
            };
            birthday = "$BIRTHDAY";
          };
        }
        EOF
      - echo "âœ… Secrets populated from 1Password (missing values left empty)"
  init:
    desc: Initial setup commands
    cmds:
      - sudo nix run nix-darwin/master#darwin-rebuild -- switch --flake ./
  git:set-remote-ssh:
    desc: Switch
    cmds:
      - git remote -v
      - git remote set-url origin git@github.com:funkymonkeymonk/nix.git
      - git remote -v
  git:set-remote-https:
    desc: Switch
    cmds:
      - git remote -v
      - git remote set-url origin https://github.com/funkymonkeymonk/nix.git
      - git remote -v
  # TODO: Add gh auth workflow
  # TODO: Add a 1Password setup flow
  # TODO: Add a git setup flow
  #
  op:signin:
    desc: Signin to 1password
    cmd: op signin
  opencode:
    desc: Run opencode with env from 1password
    cmds:
      - task op:signin
      - op run -- opencode
  flake:update:
    desc: Update the nix flake to latest versions
    cmd: nix flake update
  test:bundle:
    desc: Run bundle tests for specific bundle and platform
    cmd: |
      if [ -z "{{.BUNDLE}}" ] || [ -z "{{.PLATFORM}}" ]; then
        echo "âŒ Usage: task test:bundle BUNDLE=<bundle> PLATFORM=<darwin|linux>"
        echo "ğŸ“¦ Available bundles: creative developer gaming entertainment workstation wweaver_llm_client wweaver_claude_client megamanx_llm_host megamanx_llm_server"
        exit 1
      fi
      echo "ğŸ§ª Testing bundle: {{.BUNDLE}} on {{.PLATFORM}}"
      nix build .#testBundles.{{.BUNDLE}}.{{.PLATFORM}}.test
  test:integration:
    desc: Run integration test for specific machine and bundle
    cmd: |
      if [ -z "{{.MACHINE}}" ] || [ -z "{{.BUNDLE}}" ]; then
        echo "âŒ Usage: task test:integration MACHINE=<machine> BUNDLE=<bundle>"
        echo "ğŸ–¥ï¸  Available machines: wweaver MegamanX drlight zero"
        exit 1
      fi
      echo "ğŸ”— Testing integration: {{.MACHINE}} + {{.BUNDLE}}"
      nix build .#testIntegrations.{{.MACHINE}}-{{.BUNDLE}}.test
  test:all-bundles:
    desc: Run all bundle tests
    cmd: |
      echo "ğŸ§ª Running all bundle tests..."
      nix build .#testBundles --keep-going --verbose
  test:all-integrations:
    desc: Run all integration tests
    cmd: |
      echo "ğŸ”— Running all integration tests..."
      nix build .#testIntegrations --keep-going --verbose
  test:generate:
    desc: Generate test configuration summary
    cmd: ./scripts/generate-tests.sh
