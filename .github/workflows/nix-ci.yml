---
name: Nix CI/CD Pipeline
# yamllint disable-line rule:truthy
on:
  pull_request:
    types: [opened, synchronize, reopened]
  push:
    branches:
      - main
  workflow_dispatch:
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true
jobs:
  # Matrix build for different architectures
  test-matrix:
    name: Test (${{ matrix.system }})
    runs-on: ${{ matrix.runner }}
    strategy:
      matrix:
        include:
          - system: x86_64-linux
            runner: ubuntu-latest
          - system: aarch64-darwin
            runner: macos-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      - name: Install Nix
        uses: DeterminateSystems/nix-installer-action@v10
        with:
          extra-conf: |
            experimental-features = nix-command flakes
            sandbox = false
      - name: Cache Nix store
        uses: actions/cache@v4
        with:
          path: |
            /nix/store
            ~/.cache/nix
          key: ${{ runner.os }}-nix-store-${{ hashFiles('**/flake.lock') }}
          restore-keys: |
            ${{ runner.os }}-nix-store-
      - name: Install devenv
        run: nix profile install nixpkgs#devenv
      - name: Run formatter
        run: devenv shell task fmt
      - name: Run configuration tests
        run: devenv shell task test

  # NixOS VM Integration Tests
  vm-tests:
    name: VM Test (${{ matrix.config }})
    runs-on: ubuntu-latest
    needs: test-matrix
    strategy:
      fail-fast: false
      matrix:
        config:
          - drlight
          - zero
        test-type:
          - basic
          - system
          - development
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install Nix
        uses: DeterminateSystems/nix-installer-action@v10
        with:
          extra-conf: |
            experimental-features = nix-command flakes
            sandbox = false

      - name: Enable KVM group permissions
        run: |
          echo 'KERNEL=="kvm", GROUP="kvm", MODE="0666", OPTIONS+="static_node=kvm"' | \
            sudo tee /etc/udev/rules.d/99-kvm4all.rules
          sudo udevadm control --reload-rules
          sudo udevadm trigger --name-match=kvm

      - name: Cache Nix store
        uses: actions/cache@v4
        with:
          path: |
            /nix/store
            ~/.cache/nix
          key: vm-${{ matrix.config }}-${{ hashFiles('**/flake.lock') }}
          restore-keys: |
            vm-${{ matrix.config }}-
            vm-

      - name: Install VM dependencies
        run: |
          nix profile install nixpkgs#qemu
          nix profile install nixpkgs#openssh
          nix profile install nixpkgs#sshpass

      - name: Build VM for ${{ matrix.config }}
        run: |
          nix build .#vm-${{ matrix.config }}

      - name: Start VM in background
        run: |
          # Set different SSH port for different VMs to avoid conflicts
          SSH_PORT="2222"
          if [[ "${{ matrix.config }}" == "zero" ]]; then
            SSH_PORT="2223"
          fi

          # Start VM in daemonized mode
          ./result/bin/run-${{ matrix.config }}-vm \
            -daemonize \
            -display none \
            -m 2048 \
            -smp 2

      - name: Wait for VM to be ready
        run: |
          # Set different SSH port for different VMs
          SSH_PORT="2222"
          if [[ "${{ matrix.config }}" == "zero" ]]; then
            SSH_PORT="2223"
          fi

          # Wait for SSH to be available
          echo "Waiting for VM SSH on port $SSH_PORT..."
          for i in {1..30}; do
            if ssh -o UserKnownHostsFile=/dev/null \
                   -o StrictHostKeyChecking=no \
                   -o ConnectTimeout=5 \
                   -o BatchMode=yes \
                   -p "$SSH_PORT" \
                   test@localhost \
                   "echo 'VM is ready'" 2>/dev/null; then
              echo "VM is ready after $i attempts"
              break
            fi
            if [[ $i -eq 30 ]]; then
              echo "VM failed to become ready after 30 attempts"
              exit 1
            fi
            sleep 2
          done

      - name: Run ${{ matrix.test-type }} tests on ${{ matrix.config }}
        run: |
          # Run the CI-optimized test script
          ./tests/vm-ci-test.sh ${{ matrix.config }} ${{ matrix.test-type }}

      - name: Cleanup VM
        if: always()
        run: |
          # Kill any remaining VM processes
          pkill -f "run-${{ matrix.config }}-vm" || true
          pkill -f "qemu-system-x86_64" || true

  # Comprehensive Integration Test
  integration-test:
    name: Integration Test (${{ matrix.config }})
    runs-on: ubuntu-latest
    needs: test-matrix
    strategy:
      fail-fast: false
      matrix:
        config:
          - drlight
          - zero
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install Nix
        uses: DeterminateSystems/nix-installer-action@v10
        with:
          extra-conf: |
            experimental-features = nix-command flakes
            sandbox = false

      - name: Enable KVM group permissions
        run: |
          echo 'KERNEL=="kvm", GROUP="kvm", MODE="0666", OPTIONS+="static_node=kvm"' | \
            sudo tee /etc/udev/rules.d/99-kvm4all.rules
          sudo udevadm control --reload-rules
          sudo udevadm trigger --name-match=kvm

      - name: Cache Nix store
        uses: actions/cache@v4
        with:
          path: |
            /nix/store
            ~/.cache/nix
          key: integration-${{ matrix.config }}-${{ hashFiles('**/flake.lock') }}
          restore-keys: |
            integration-${{ matrix.config }}-
            integration-

      - name: Install VM dependencies
        run: |
          nix profile install nixpkgs#qemu
          nix profile install nixpkgs#openssh
          nix profile install nixpkgs#sshpass

      - name: Build and start VM
        run: |
          # Set different SSH port for different VMs
          SSH_PORT="2222"
          if [[ "${{ matrix.config }}" == "zero" ]]; then
            SSH_PORT="2223"
          fi

          # Build VM
          nix build .#vm-${{ matrix.config }}

          # Start VM in daemonized mode
          ./result/bin/run-${{ matrix.config }}-vm \
            -daemonize \
            -display none \
            -m 2048 \
            -smp 2

      - name: Wait for VM and run integration test
        run: |
          # Set different SSH port for different VMs
          SSH_PORT="2222"
          if [[ "${{ matrix.config }}" == "zero" ]]; then
            SSH_PORT="2223"
          fi

          # Wait for VM to be ready
          echo "Waiting for VM SSH on port $SSH_PORT..."
          for i in {1..30}; do
            if ssh -o UserKnownHostsFile=/dev/null \
                   -o StrictHostKeyChecking=no \
                   -o ConnectTimeout=5 \
                   -o BatchMode=yes \
                   -p "$SSH_PORT" \
                   test@localhost \
                   "echo 'VM is ready'" 2>/dev/null; then
              echo "VM is ready after $i attempts"
              break
            fi
            if [[ $i -eq 30 ]]; then
              echo "VM failed to become ready after 30 attempts"
              exit 1
            fi
            sleep 2
          done

          # Copy and run the integration test script
          scp -o UserKnownHostsFile=/dev/null \
              -o StrictHostKeyChecking=no \
              -o ConnectTimeout=10 \
              -P "$SSH_PORT" \
              ./tests/nixos-integration-test.sh \
              test@localhost:/tmp/

          # Execute the integration test
          ssh -o UserKnownHostsFile=/dev/null \
              -o StrictHostKeyChecking=no \
              -o ConnectTimeout=10 \
              -p "$SSH_PORT" \
              test@localhost \
              "chmod +x /tmp/nixos-integration-test.sh && /tmp/nixos-integration-test.sh"

      - name: Cleanup VM
        if: always()
        run: |
          # Kill any remaining VM processes
          pkill -f "run-${{ matrix.config }}-vm" || true
          pkill -f "qemu-system-x86_64" || true
