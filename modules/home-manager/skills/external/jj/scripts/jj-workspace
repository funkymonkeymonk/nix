#!/usr/bin/env bash
# jj-workspace: Manage jj workspaces for isolated work
# Usage: jj-workspace <command> [args]
# Example: jj-workspace create feature-auth

set -euo pipefail

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

WORKSPACES_DIR="./workspaces"

usage() {
    cat <<EOF
Usage: jj-workspace <command> [args]

Manage jj workspaces for isolated multi-task work.

Commands:
  create <name> [base]   Create a new workspace (default base: main)
  list                   List all workspaces
  remove <name>          Remove a workspace
  clean                  Remove all workspaces
  status                 Show status of all workspaces

Examples:
  jj-workspace create feature-auth          # New workspace from main
  jj-workspace create bugfix-login develop  # New workspace from develop
  jj-workspace list                         # Show all workspaces
  jj-workspace remove feature-auth          # Remove workspace
  jj-workspace clean                        # Remove all workspaces
EOF
    exit 1
}

# Ensure workspaces directory exists
ensure_workspaces_dir() {
    if [[ ! -d "$WORKSPACES_DIR" ]]; then
        mkdir -p "$WORKSPACES_DIR"
        echo -e "${YELLOW}Created workspaces directory: ${WORKSPACES_DIR}${NC}"
        
        # Check if .gitignore exists and add workspaces/ if needed
        if [[ -f .gitignore ]]; then
            if ! grep -q "^workspaces/" .gitignore; then
                echo "workspaces/" >> .gitignore
                echo -e "${YELLOW}Added workspaces/ to .gitignore${NC}"
            fi
        fi
    fi
}

cmd_create() {
    local name="${1:-}"
    local base="${2:-main}"
    
    if [[ -z "$name" ]]; then
        echo -e "${RED}Error: Workspace name required${NC}"
        echo "Usage: jj-workspace create <name> [base]"
        exit 1
    fi
    
    ensure_workspaces_dir
    
    local workspace_path="${WORKSPACES_DIR}/${name}"
    
    if [[ -d "$workspace_path" ]]; then
        echo -e "${RED}Error: Workspace already exists: ${workspace_path}${NC}"
        exit 1
    fi
    
    echo -e "${GREEN}Creating workspace: ${name} (base: ${base})${NC}"
    jj workspace add "$workspace_path" -r "$base"
    
    echo -e "\n${GREEN}Workspace created!${NC}"
    echo -e "To use: ${BLUE}cd ${workspace_path}${NC}"
    echo -e "Then:   ${BLUE}jj new${NC} to start working"
}

cmd_list() {
    echo -e "${GREEN}Workspaces:${NC}\n"
    jj workspace list
    
    if [[ -d "$WORKSPACES_DIR" ]]; then
        echo -e "\n${GREEN}Workspace directories:${NC}"
        for dir in "$WORKSPACES_DIR"/*/; do
            if [[ -d "$dir" ]]; then
                local name=$(basename "$dir")
                echo -e "  ${BLUE}${name}${NC} -> ${dir}"
            fi
        done
    fi
}

cmd_remove() {
    local name="${1:-}"
    
    if [[ -z "$name" ]]; then
        echo -e "${RED}Error: Workspace name required${NC}"
        echo "Usage: jj-workspace remove <name>"
        exit 1
    fi
    
    local workspace_path="${WORKSPACES_DIR}/${name}"
    
    echo -e "${YELLOW}Removing workspace: ${name}${NC}"
    
    # Forget the workspace in jj
    if jj workspace list | grep -q "$name"; then
        jj workspace forget "$name"
        echo -e "${GREEN}Workspace forgotten from jj${NC}"
    fi
    
    # Remove the directory
    if [[ -d "$workspace_path" ]]; then
        rm -rf "$workspace_path"
        echo -e "${GREEN}Directory removed: ${workspace_path}${NC}"
    fi
    
    echo -e "\n${GREEN}Done!${NC}"
}

cmd_clean() {
    echo -e "${YELLOW}This will remove ALL workspaces.${NC}"
    read -p "Are you sure? [y/N] " -n 1 -r
    echo
    
    if [[ ! $REPLY =~ ^[Yy]$ ]]; then
        echo "Cancelled."
        exit 0
    fi
    
    # Get list of workspaces
    local workspaces=$(jj workspace list | grep -v "^default" | awk '{print $1}' || true)
    
    for ws in $workspaces; do
        if [[ -n "$ws" && "$ws" != "default" ]]; then
            echo -e "${YELLOW}Forgetting: ${ws}${NC}"
            jj workspace forget "$ws" 2>/dev/null || true
        fi
    done
    
    # Remove directory
    if [[ -d "$WORKSPACES_DIR" ]]; then
        rm -rf "$WORKSPACES_DIR"
        echo -e "${GREEN}Removed: ${WORKSPACES_DIR}${NC}"
    fi
    
    echo -e "\n${GREEN}All workspaces cleaned!${NC}"
}

cmd_status() {
    echo -e "${GREEN}Workspace Status:${NC}\n"
    
    # Show jj workspace list
    jj workspace list
    
    echo ""
    
    # Show each workspace's current state
    if [[ -d "$WORKSPACES_DIR" ]]; then
        for dir in "$WORKSPACES_DIR"/*/; do
            if [[ -d "$dir" ]]; then
                local name=$(basename "$dir")
                echo -e "${BLUE}${name}:${NC}"
                (cd "$dir" && jj log -r '@' --no-graph -T 'concat(change_id.short(), " ", description.first_line())' 2>/dev/null || echo "  (error reading)")
                echo ""
            fi
        done
    fi
}

# Main
COMMAND="${1:-}"

case "$COMMAND" in
    create)
        shift
        cmd_create "$@"
        ;;
    list|ls)
        cmd_list
        ;;
    remove|rm)
        shift
        cmd_remove "$@"
        ;;
    clean)
        cmd_clean
        ;;
    status)
        cmd_status
        ;;
    -h|--help|"")
        usage
        ;;
    *)
        echo -e "${RED}Unknown command: ${COMMAND}${NC}"
        usage
        ;;
esac
