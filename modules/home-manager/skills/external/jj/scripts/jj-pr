#!/usr/bin/env bash
# jj-pr: Create a new PR with conventional branch naming
# Usage: jj-pr <type> <description> [commit-message]
# Example: jj-pr feat user-auth "Add user authentication flow"

set -euo pipefail

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

usage() {
    cat <<EOF
Usage: jj-pr <type> <description> [commit-message]

Create a new PR with conventional branch naming.

Types:
  feat, feature  - New features
  fix, bugfix    - Bug fixes
  hotfix         - Urgent fixes
  release        - Release preparation
  chore          - Non-code tasks (deps, docs)

Arguments:
  type           - Branch type prefix
  description    - Branch description (kebab-case)
  commit-message - Optional commit message (uses description if not provided)

Examples:
  jj-pr feat user-auth "Add user authentication flow"
  jj-pr fix null-pointer
  jj-pr chore deps-update "Update dependencies to latest versions"
EOF
    exit 1
}

# Validate type
validate_type() {
    local type="$1"
    case "$type" in
        feat|feature|fix|bugfix|hotfix|release|chore)
            return 0
            ;;
        *)
            echo -e "${RED}Error: Invalid type '$type'${NC}"
            echo "Valid types: feat, feature, fix, bugfix, hotfix, release, chore"
            exit 1
            ;;
    esac
}

# Normalize type (feature -> feat, bugfix -> fix)
normalize_type() {
    local type="$1"
    case "$type" in
        feature) echo "feat" ;;
        bugfix) echo "fix" ;;
        *) echo "$type" ;;
    esac
}

# Validate description (kebab-case, no special chars)
validate_description() {
    local desc="$1"
    if [[ ! "$desc" =~ ^[a-z0-9]+(-[a-z0-9]+)*$ ]]; then
        echo -e "${RED}Error: Description must be kebab-case (lowercase, hyphens only)${NC}"
        echo "Got: $desc"
        echo "Example: user-auth, fix-null-pointer, gh-123-add-feature"
        exit 1
    fi
}

# Main
if [[ $# -lt 2 ]]; then
    usage
fi

TYPE="$1"
DESC="$2"
MESSAGE="${3:-$DESC}"

validate_type "$TYPE"
validate_description "$DESC"

TYPE=$(normalize_type "$TYPE")
BRANCH="${TYPE}/${DESC}"

echo -e "${YELLOW}Creating PR with branch: ${BRANCH}${NC}"

# Check current state
echo -e "\n${GREEN}1. Checking status...${NC}"
jj status

# Check if we have changes
if jj diff --stat | grep -q .; then
    echo -e "\n${GREEN}2. Changes detected in working copy${NC}"
else
    echo -e "\n${YELLOW}Warning: No changes in working copy${NC}"
    read -p "Continue anyway? [y/N] " -n 1 -r
    echo
    if [[ ! $REPLY =~ ^[Yy]$ ]]; then
        exit 1
    fi
fi

# Describe the commit
echo -e "\n${GREEN}3. Setting commit message...${NC}"
jj describe -m "$MESSAGE"

# Create bookmark
echo -e "\n${GREEN}4. Creating bookmark: ${BRANCH}${NC}"
jj bookmark set "$BRANCH" -r @

# Push to remote
echo -e "\n${GREEN}5. Pushing to remote...${NC}"
jj git push --bookmark "$BRANCH" --allow-new

# Create PR
echo -e "\n${GREEN}6. Creating PR...${NC}"
gh pr create --head "$BRANCH" --fill

echo -e "\n${GREEN}Done! PR created with branch: ${BRANCH}${NC}"
